<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Robocar Farm Demo â€“ Weed Spray System</title>
<style>
body { margin:0; }
#legend {
  position: absolute;
  top: 10px;
  right: 10px;
  background: rgba(255,255,255,0.8);
  padding: 10px 15px;
  border-radius: 10px;
  font-family: Arial, sans-serif;
  font-size: 14px;
  line-height: 1.4em;
}
#legend h3 {
  margin: 0 0 5px 0;
  font-size: 16px;
  text-align: center;
}
</style>
</head>
<body>
<div id="legend">
  <h3>Legend</h3>
  ðŸš— Robocar Base <br>
  âš« Wheels <br>
  ðŸ’§ Spray Tank <br>
  ðŸ“· Camera Module <br>
  ðŸ”‹ Battery <br>
  ðŸ“¡ Sensors <br>
  ðŸš¿ Nozzles <br>
  ðŸŒ± Normal Plant <br>
  ðŸŒ¿ Weed Plant (ðŸ”´ after spray) <br>
  âœ¨ Spray Mist <br>
  â›° Hills <br>
  ðŸŒ³ Trees <br>
  ðŸŸ© Ground
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script>
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

// Cameras
const topCamera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
topCamera.position.set(0,100,140); topCamera.lookAt(0,0,0);
const followCamera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);

// Renderer
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth,window.innerHeight);
document.body.appendChild(renderer.domElement);

// Lights
scene.add(new THREE.AmbientLight(0xffffff,0.7));
const dirLight = new THREE.DirectionalLight(0xffffff,0.8); dirLight.position.set(100,150,100); scene.add(dirLight);

// Ground
const ground = new THREE.Mesh(new THREE.PlaneGeometry(60,60), new THREE.MeshLambertMaterial({color:0x6aa84f}));
ground.rotation.x = -Math.PI/2; scene.add(ground);

// Hills
function addHill(x,z,h,r,color){
  const hill = new THREE.Mesh(new THREE.ConeGeometry(r,h,32), new THREE.MeshLambertMaterial({color:color}));
  hill.position.set(x,h/2,z); scene.add(hill);
}
for(let i=-50;i<=50;i+=25){
  addHill(i,-50,12,12,0x556b2f);
  addHill(i+10,-60,10,10,0x6b8e23);
}

// Trees
function addTree(x,z,scale=1){
  const tree=new THREE.Group();
  const trunk=new THREE.Mesh(new THREE.CylinderGeometry(0.5*scale,0.5*scale,4*scale,12), new THREE.MeshLambertMaterial({color:0x8b4513}));
  trunk.position.y=2*scale; tree.add(trunk);
  const foliage=new THREE.Mesh(new THREE.ConeGeometry(2*scale,5*scale,8), new THREE.MeshLambertMaterial({color:0x228b22}));
  foliage.position.y=5*scale; tree.add(foliage);
  tree.position.set(x,0,z); scene.add(tree);
}
for(let i=-40;i<=40;i+=15){ addTree(i,-45,1.2); addTree(i,-35,1); }

// Robocar
const robocar = new THREE.Group(); robocar.position.set(-25,0,-25);

// Base
const baseMat = new THREE.MeshPhongMaterial({color:0x1e3a8a, shininess:80, transparent:true, opacity:0.6});
const base = new THREE.Mesh(new THREE.BoxGeometry(12,2.5,6), baseMat); base.position.y=1.25; robocar.add(base);

// Wheels
const wheelGeo=new THREE.CylinderGeometry(1.5,1.5,1.2,16);
const wheelMat=new THREE.MeshLambertMaterial({color:0x222222});
function addWheel(x,z){
  const w=new THREE.Mesh(wheelGeo,wheelMat);
  w.rotation.z=Math.PI/2; w.position.set(x,1.25,z);
  robocar.add(w);
}
addWheel(5,2.5); addWheel(-5,2.5); addWheel(5,-2.5); addWheel(-5,-2.5);

// Spray tank
const tank = new THREE.Mesh(new THREE.CylinderGeometry(2,2,4,32), new THREE.MeshPhongMaterial({color:0x1565c0, shininess:50}));
tank.rotation.z=Math.PI/2; tank.position.set(-3,3.5,0); robocar.add(tank);

// Camera module
const camModule = new THREE.Mesh(new THREE.BoxGeometry(1.5,1,1.5), new THREE.MeshLambertMaterial({color:0x000000}));
camModule.position.set(4,2.5,0); robocar.add(camModule);

// Battery
const battery = new THREE.Mesh(new THREE.BoxGeometry(1.5,1,2), new THREE.MeshLambertMaterial({color:0xffa500}));
battery.position.set(-4,2,0); robocar.add(battery);

// Sensors
const sensorMat = new THREE.MeshLambertMaterial({color:0x555555});
for(let i=-1;i<=1;i+=2){
  const s=new THREE.Mesh(new THREE.CylinderGeometry(0.25,0.25,0.8,12),sensorMat);
  s.rotation.x=Math.PI/2; s.position.set(0,2,i*2.5); robocar.add(s);
}

// Nozzles
const nozzleMat=new THREE.MeshLambertMaterial({color:0x444444});
const nozzle1=new THREE.Mesh(new THREE.CylinderGeometry(0.15,0.15,0.8,12),nozzleMat);
nozzle1.rotation.z=Math.PI/2; nozzle1.position.set(5.5,2,1.2); robocar.add(nozzle1);
const nozzle2=nozzle1.clone(); nozzle2.position.set(5.5,2,-1.2); robocar.add(nozzle2);

scene.add(robocar);

// Plants
function createPlant(x,z,weed=false){
  const plant=new THREE.Group();
  const stem=new THREE.Mesh(new THREE.CylinderGeometry(0.25,0.25,3.5,8),
    new THREE.MeshLambertMaterial({color:weed?0x2d572c:0x2d752c}));
  stem.position.y=1.75; plant.add(stem);
  const leafGeo=new THREE.ConeGeometry(1.5,3,8);
  const leafMat=new THREE.MeshLambertMaterial({color:weed?0x1f7a1f:0x228b22});
  for(let i=0;i<3;i++){
    const leaf=new THREE.Mesh(leafGeo,leafMat);
    leaf.position.y=2.5; leaf.rotation.z=i*2*Math.PI/3; plant.add(leaf);
  }
  plant.position.set(x,0,z);
  scene.add(plant);
  plant.userData.isWeed=weed;
  return plant;
}
const plants=[];
for(let i=-25;i<=25;i+=10){
  for(let j=-25;j<=25;j+=10){
    plants.push(createPlant(i,j,false));
  }
}
for(let i=0;i<8;i++){
  plants.push(createPlant((Math.random()*50)-25,(Math.random()*50)-25,true));
}

// Spray particles
const sprayParticles=[];
function sprayFromNozzle(nozzle){
  const np=new THREE.Vector3(); nozzle.getWorldPosition(np);
  for(let i=0;i<12;i++){ // more particles
    const p=new THREE.Mesh(
      new THREE.SphereGeometry(0.22,10,10),
      new THREE.MeshBasicMaterial({color:0x00bfff,transparent:true,opacity:1})
    );
    p.position.copy(np);
    p.userData={
      vx:(Math.random()-0.5)*0.15,
      vy:-0.03,
      vz:(Math.random()-0.5)*0.15,
      fade:0.005
    };
    scene.add(p);
    sprayParticles.push(p);
  }
}

// Path
const path=[]; let dir=1;
for(let z=-25;z<=25;z+=10){
  if(dir===1){
    path.push(new THREE.Vector3(-25,0,z));
    path.push(new THREE.Vector3(25,0,z));
  } else {
    path.push(new THREE.Vector3(25,0,z));
    path.push(new THREE.Vector3(-25,0,z));
  }
  dir*=-1;
}
let currentPoint=0; let pauseTimer=0; let useFollow=true;

function animate(){
  requestAnimationFrame(animate);

  if(pauseTimer>0){
    sprayFromNozzle(nozzle1);
    sprayFromNozzle(nozzle2);
    pauseTimer--;
  }
  else if(currentPoint<path.length-1){
    const target=path[currentPoint+1];
    let speed=0.004+Math.random()*0.004;
    robocar.position.lerp(target,speed);
    robocar.lookAt(target);
    if(robocar.position.distanceTo(target)<1) currentPoint++;
  }

  // Weed detection (only spray on weeds)
  plants.forEach(p=>{
    if(p.userData.isWeed && !p.userData.sprayed){
      const dist=robocar.position.distanceTo(p.position);
      if(dist<8 && pauseTimer===0){
        p.traverse(o=>{ if(o.material) o.material.color.set(0xff0000); });
        p.userData.sprayed=true;
        pauseTimer=80; // longer intense spray
      }
    }
  });

  // Spray animation
  sprayParticles.forEach((p,i)=>{
    p.position.x+=p.userData.vx;
    p.position.y+=p.userData.vy;
    p.position.z+=p.userData.vz;
    p.material.opacity-=p.userData.fade;
    if(p.material.opacity<=0){
      scene.remove(p);
      sprayParticles.splice(i,1);
    }
  });

  if(useFollow){
    followCamera.position.set(robocar.position.x-15,robocar.position.y+10,robocar.position.z+15);
    followCamera.lookAt(robocar.position.x,robocar.position.y+2,robocar.position.z);
    renderer.render(scene,followCamera);
  }
  else{
    renderer.render(scene,topCamera);
  }
}
animate();

// Camera toggle
window.addEventListener('keydown',(e)=>{
  if(e.key==='c'||e.key==='C') useFollow=!useFollow;
});
window.addEventListener('resize',()=>{
  topCamera.aspect=window.innerWidth/window.innerHeight; topCamera.updateProjectionMatrix();
  followCamera.aspect=window.innerWidth/window.innerHeight; followCamera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth,window.innerHeight);
});
</script>
</body>
</html>